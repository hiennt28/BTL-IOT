<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Bệnh nhân</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ... CSS không đổi ... */
body {font-family: Arial, sans-serif;}
.sidebar {width: 200px; position: fixed; top:0; left:0; height:100%; background:#343a40; padding-top:20px;}
.sidebar .nav-link {color:#fff; display:block; padding:10px;}
.sidebar .nav-link.active {background:#495057;}
.content {margin-left:210px; padding:20px;}
.card {margin-bottom:15px;}
.tab-content {margin-top:15px;}

/* CSS cho User Profile Box (Đã xóa avatar) */
.user-profile {
  text-align: center;
  padding: 15px;
  border-bottom: 1px solid #495057; /* Đường viền mờ */
  margin-bottom: 10px;
}
.user-profile h5 {
  color: #fff;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 3px;
}
.user-profile p {
  color: #adb5bd; /* Màu xám nhạt */
  font-size: 0.9rem;
  margin-bottom: 0;
  text-transform: capitalize; /* Viết hoa chữ cái đầu */
}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <!-- MỚI: User Profile Box (Đã xóa avatar) -->
    <div class="user-profile">
        <h5 id="userProfileName">Đang tải...</h5>
        <p id="userProfileRole">Bệnh nhân</p>
    </div>
    <!-- Kết thúc User Profile Box -->

    <a href="#" class="nav-link active" data-tab="info">Thông tin cá nhân</a>
    <a href="#" class="nav-link" data-tab="health">Theo dõi sức khỏe</a>
    <a href="#" class="nav-link" data-tab="alerts">Cảnh báo</a>
    <a href="#" class="nav-link" data-tab="history">Lịch sử</a>
    <hr>
    <button id="logoutBtn" class="btn btn-danger w-100">Đăng xuất</button>
</div>

<div class="content">
    <!-- Thông tin cá nhân -->
    <div id="tab-info" class="tab-content">
        <h3>Thông tin cá nhân</h3>
        <p>Họ và tên: <span id="full_name"></span></p>
        <p>Email: <span id="email"></span></p>
        <p>Số điện thoại: <span id="phone_number"></span></p>
        <p>Địa chỉ: <span id="address"></span></p>
        <p>Ngày sinh: <span id="date_of_birth"></span></p>
        
        <p><strong>Bác sĩ phụ trách:</strong> <span id="doctor_name" class="text-primary fw-bold"></span></p>

        <button id="update-info-btn" class="btn btn-primary">Cập nhật thông tin</button>
        <button id="change-pass-btn" class="btn btn-warning">Đổi mật khẩu</button>
    </div>

    <!-- Theo dõi sức khỏe -->
    <div id="tab-health" class="tab-content d-none">
        <h3>Dữ liệu sức khỏe</h3>
        <div class="row">
            <div class="col-md-2"><div class="card"><div class="card-body">BPM: <span id="bpm_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">IR: <span id="ir_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">Accel X: <span id="accel_x_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">Accel Y: <span id="accel_y_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">Accel Z: <span id="accel_z_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">A total: <span id="a_total_val">0</span></div></div></div>
        </div>
        <hr>
        <label>Chọn khoảng thời gian:</label>
        <select id="chart-range" class="form-select w-25 mb-3">
            <option value="day">Ngày</option>
            <option value="week">Tuần</option>
            <option value="month">Tháng</option>
        </select>
        <canvas id="bpmChart" height="150"></canvas>
    </div>

    <!-- Cảnh báo -->
    <div id="tab-alerts" class="tab-content d-none">
        <h3>Cảnh báo</h3>
        <div id="alerts-table" class="list-group"></div>
    </div>

    <!-- Lịch sử -->
    <div id="tab-history" class="tab-content d-none">
        <h3>Lịch sử đo sức khỏe</h3>
        <table class="table table-bordered table-striped">
            <thead>
                <tr><th>BPM</th><th>IR</th><th>Accel X</th><th>Accel Y</th><th>Accel Z</th><th>A total</th><th>Thời gian</th></tr>
            </thead>
            <tbody id="history-table-body"></tbody>
        </table>
    </div>
</div>

<!-- Modal cập nhật thông tin cá nhân -->
<div class="modal fade" id="updateInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cập nhật thông tin cá nhân</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateInfoForm">
          <div class="mb-3">
            <label for="modalFullName" class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="modalFullName" required>
          </div>
          <div class="mb-3">
            <label for="modalPhone" class="form-label">Số điện thoại</label>
            <input type="text" class="form-control" id="modalPhone">
          </div>
          <div class="mb-3">
            <label for="modalAddress" class="form-label">Địa chỉ</label>
            <input type="text" class="form-control" id="modalAddress">
          </div>
          <div class="mb-3">
            <label for="modalDOB" class="form-label">Ngày sinh</label>
            <input type="date" class="form-control" id="modalDOB">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="saveInfoBtn">Lưu</button>
      </div>
    </div>
  </div>
</div>

<!-- MỚI: Modal Đổi mật khẩu -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Đổi mật khẩu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div id="changePassMsg" class="alert d-none" role="alert"></div>
          <div class="mb-3">
            <label for="modalOldPass" class="form-label">Mật khẩu cũ</label>
            <input type="password" class="form-control" id="modalOldPass" required>
          </div>
          <div class="mb-3">
            <label for="modalNewPass" class="form-label">Mật khẩu mới</label>
            <input type="password" class="form-control" id="modalNewPass" required>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="saveNewPassBtn">Lưu</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// === BẮT ĐẦU CẬP NHẬT: Thêm hàm định dạng ngày ===
/**
 * Chuyển đổi chuỗi ngày (GMT hoặc ISO) thành dd/mm/yyyy
 * @param {string} dateString
 * @returns {string}
 */
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        // Lấy ngày, tháng, năm (UTC để tránh lệch múi giờ khi chuyển đổi)
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
    } catch (e) {
        console.error("Lỗi định dạng ngày:", dateString, e);
        return dateString; // Trả về chuỗi gốc nếu lỗi
    }
}

/**
 * Chuyển đổi chuỗi ngày (GMT hoặc ISO) thành yyyy-mm-dd
 * @param {string} dateString
 * @returns {string}
 */
function formatDateForInput(dateString) {
    if (!dateString) return '';
     try {
        const date = new Date(dateString);
        // Lấy ngày, tháng, năm (UTC để tránh lệch múi giờ)
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${year}-${month}-${day}`;
     } catch (e) {
        return ''; // Trả về rỗng nếu lỗi
     }
}
// === KẾT THÚC CẬP NHẬT ===


document.addEventListener("DOMContentLoaded", async () => {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role !== 'patient') { window.location.href="/login.html"; return; }
    
    const patientId = user.patient_id;
    
    // Cập nhật tên và vai trò trên sidebar
    document.getElementById("userProfileName").innerText = user.full_name;
    document.getElementById("userProfileRole").innerText = user.role;

    let updateInfoModal;
    let changePasswordModal;
    let currentPatientData = {}; // MỚI: Biến lưu trữ dữ liệu gốc

    // Khởi tạo Modals
    if (document.getElementById('updateInfoModal')) {
        updateInfoModal = new bootstrap.Modal(document.getElementById('updateInfoModal'));
    }
    if (document.getElementById('changePasswordModal')) {
        changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
    }

    // Sidebar tab switching
    document.querySelectorAll("#sidebar .nav-link").forEach(link => {
        link.addEventListener("click", e => {
            e.preventDefault();
            document.querySelectorAll("#sidebar .nav-link").forEach(l=>l.classList.remove("active"));
            link.classList.add("active");
            document.querySelectorAll(".tab-content").forEach(t=>t.classList.add("d-none"));
            document.getElementById("tab-" + link.dataset.tab).classList.remove("d-none");
        });
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", ()=> {
        localStorage.removeItem("user");
        window.location.href="/login.html";
    });

    // Load thông tin cá nhân
    async function loadPatientInfo() {
        try {
            const res = await fetch(`/api/patients/${patientId}`);
            if(!res.ok) throw new Error("Không tìm thấy bệnh nhân!");
            const data = await res.json();
            
            currentPatientData = data; // MỚI: Lưu dữ liệu gốc

            document.getElementById("full_name").innerText = data.full_name;
            document.getElementById("email").innerText = data.email; 
            document.getElementById("phone_number").innerText = data.phone_number || '';
            document.getElementById("address").innerText = data.address || '';
            
            // === BẮT ĐẦU CẬP NHẬT: Dùng hàm formatDate ===
            document.getElementById("date_of_birth").innerText = formatDate(data.date_of_birth) || '';
            // === KẾT THÚC CẬP NHẬT ===

            document.getElementById("doctor_name").innerText = data.doctor_name || 'Chưa được gán';

        } catch(err) { console.error("Lỗi khi lấy dữ liệu bệnh nhân!", err); }
    }
    await loadPatientInfo();

    // Modal cập nhật thông tin
    document.getElementById("update-info-btn").addEventListener("click", ()=> {
        // MỚI: Dùng dữ liệu gốc đã lưu
        document.getElementById("modalFullName").value = currentPatientData.full_name || '';
        document.getElementById("modalPhone").value = currentPatientData.phone_number || '';
        document.getElementById("modalAddress").value = currentPatientData.address || '';
        
        // === BẮT ĐẦU CẬP NHẬT: Dùng hàm formatDateForInput ===
        document.getElementById("modalDOB").value = formatDateForInput(currentPatientData.date_of_birth) || '';
        // === KẾT THÚC CẬP NHẬT ===
        
        updateInfoModal.show();
    });

    document.getElementById("saveInfoBtn").addEventListener("click", async ()=> {
        const full_name = document.getElementById("modalFullName").value;
        const phone_number = document.getElementById("modalPhone").value;
        const address = document.getElementById("modalAddress").value;
        const date_of_birth = document.getElementById("modalDOB").value;

        try {
            const res = await fetch(`/api/patients/update/${patientId}`, {
                method:"PUT",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify({full_name, phone_number, address, date_of_birth})
            });
            if(!res.ok) throw new Error("Cập nhật thất bại!");
            await loadPatientInfo(); // Tải lại thông tin đã định dạng
            updateInfoModal.hide();
        } catch(err) { alert(err.message); }
    });
    
    // MỚI: Mở modal đổi mật khẩu
    document.getElementById("change-pass-btn").addEventListener("click", () => {
        document.getElementById("modalOldPass").value = "";
        document.getElementById("modalNewPass").value = "";
        document.getElementById("changePassMsg").classList.add('d-none');
        changePasswordModal.show();
    });

    // MỚI: Xử lý đổi mật khẩu
    document.getElementById("saveNewPassBtn").addEventListener("click", async () => {
        const old_password = document.getElementById("modalOldPass").value;
        const new_password = document.getElementById("modalNewPass").value;
        const msgEl = document.getElementById("changePassMsg");

        try {
            const res = await fetch(`/api/auth/change-password`, {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify({ 
                    email: user.email, 
                    role: user.role,
                    old_password, 
                    new_password 
                })
            });
            const data = await res.json();
            
            if (data.success) {
                msgEl.textContent = data.message;
                msgEl.className = 'alert alert-success';
                setTimeout(() => changePasswordModal.hide(), 1500);
            } else {
                msgEl.textContent = data.message;
                msgEl.className = 'alert alert-danger';
            }
        } catch(err) {
            msgEl.textContent = "Lỗi máy chủ!";
            msgEl.className = 'alert alert-danger';
        }
    });


    // Load dữ liệu realtime health
    async function loadLatestHealth(){
        try {
            const res = await fetch(`/api/health/latest/${patientId}`);
            if(!res.ok) return;
            const data = await res.json();
            document.getElementById("bpm_val").innerText = data.bpm || 'N/A';
            document.getElementById("ir_val").innerText = data.ir_value || 'N/A';
            document.getElementById("accel_x_val").innerText = data.accel_x || 'N/A';
            document.getElementById("accel_y_val").innerText = data.accel_y || 'N/A';
            document.getElementById("accel_z_val").innerText = data.accel_z || 'N/A';
            document.getElementById("a_total_val").innerText = data.a_total || 'N/A';
        } catch(err) { console.error(err); }
    }
    loadLatestHealth(); setInterval(loadLatestHealth, 5000);

    // Load chart
    let bpmChart;
    async function loadChart(range="day"){
        try {
            const res = await fetch(`/api/health/history/${patientId}?range=${range}`);
            if(!res.ok) return;
            const data = await res.json();
            const ctx = document.getElementById("bpmChart").getContext("2d");
            const labels = data.map(d=>new Date(d.timestamp).toLocaleString());
            const bpmValues = data.map(d=>d.bpm);
            if(bpmChart) bpmChart.destroy();
            bpmChart = new Chart(ctx,{
                type:"line",
                data:{labels,datasets:[{label:"BPM",data:bpmValues,borderColor:"red",fill:false}]},
                options:{responsive:true,maintainAspectRatio:false}
            });
        } catch(err){ console.error(err); }
    }
    loadChart("day");
    document.getElementById("chart-range").addEventListener("change", e=> loadChart(e.target.value));

    // Load alerts
    async function loadAlerts(){
        try {
            const res = await fetch(`/api/alerts/${patientId}`);
            if(!res.ok) return;
            const data = await res.json();
            const container = document.getElementById("alerts-table");
            container.innerHTML = "";
            if (data.length === 0) {
                container.innerHTML = "<p>Không có cảnh báo nào.</p>";
                return;
            }
            data.forEach(a=>{
                const div = document.createElement("div");
                let statusClass = 'list-group-item-secondary';
                if (a.status === 'new') statusClass = 'list-group-item-danger';
                if (a.status === 'viewed') statusClass = 'list-group-item-warning';
                
                div.className = "list-group-item " + statusClass;
                div.innerHTML = `
                    <strong>${a.alert_type} (Trạng thái: ${a.status})</strong>
                    <p>${a.message}</p>
                    <small class="text-muted">${new Date(a.timestamp).toLocaleString()}</small>
                `;
                container.appendChild(div);
            });
        } catch(err){ console.error(err); }
    }
    loadAlerts();

    // Load history
    async function loadHistory(){
        try {
            const res = await fetch(`/api/health/history/${patientId}?range=month`); // Lấy 1 tháng gần nhất
            if(!res.ok) return;
            const data = await res.json();
            const tbody = document.getElementById("history-table-body");
            tbody.innerHTML = "";
            // Hiển thị 50 bản ghi gần nhất
            data.reverse().slice(0, 50).forEach(d=>{
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${d.bpm || ''}</td>
                    <td>${d.ir_value || ''}</td>
                    <td>${d.accel_x || ''}</td>
                    <td>${d.accel_y || ''}</td>
                    <td>${d.accel_z || ''}</td>
                    <td>${d.a_total || ''}</td>
                    <td>${new Date(d.timestamp).toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });
        } catch(err){ console.error(err); }
    }
    loadHistory();
});
</script>

</body>
</html>