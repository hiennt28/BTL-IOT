<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Bệnh nhân</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Thêm Icon Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="assets/css/style.css">
<style>
body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5;}
.sidebar {width: 250px; position: fixed; top:0; left:0; height:100%; background:#212529; padding-top:20px; transition: all 0.3s; z-index: 1000;}
.sidebar .nav-link {color:rgba(255,255,255,0.75); display:flex; align-items:center; padding:12px 25px; margin-bottom: 5px; border-radius: 0 25px 25px 0; margin-right: 10px;}
.sidebar .nav-link:hover {color: #fff; background: rgba(255,255,255,0.1);}
.sidebar .nav-link.active {background:#0d6efd; color: white; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);}
.sidebar .nav-link i { margin-right: 10px; font-size: 1.1rem; }

.content {margin-left:250px; padding:30px; min-height: 100vh;}

/* Card Styles */
.card {border: none; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); background: white; margin-bottom: 20px; transition: transform 0.2s;}
.card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.card-header { background: transparent; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 15px 20px; font-weight: 600; color: #495057; }

.user-profile { text-align: center; padding: 20px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
.user-profile img { width: 90px; height: 90px; border-radius: 50%; background: #fff; padding: 3px; margin-bottom: 15px; object-fit: cover;}
.user-profile h5 { color: #fff; font-weight: 600; font-size: 1.1rem; margin-bottom: 5px; }
.user-profile p { color: #adb5bd; font-size: 0.9rem; margin-bottom: 0; text-transform: capitalize; }

/* Status Colors */
.status-normal { color: #198754; }
.status-light { color: #0dcaf0; }
.status-medium { color: #fd7e14; }
.status-strong { color: #dc3545; }
.status-warning { color: #dc3545; font-weight: bold; }
.status-unknown { color: #6c757d; }

@keyframes blinker { 50% { opacity: 0.5; } }
.blink { animation: blinker 1.5s linear infinite; color: #dc3545; }
.device-active { color: #198754; } /* Màu xanh khi đang đo */
.device-inactive { color: #6c757d; }

/* Chart Container */
.chart-container {
    position: relative;
    height: 400px;
    width: 100%;
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
}
.stat-value { font-size: 1.5rem; font-weight: 700; margin-top: 5px; }
.stat-label { font-size: 0.85rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="user-profile">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar"> 
        <h5 id="userProfileName">Đang tải...</h5>
        <p id="userProfileRole">Bệnh nhân</p>
    </div>

    <a href="#" class="nav-link active" data-tab="info"><i class="bi bi-person-vcard"></i> Thông tin cá nhân</a>
    <a href="#" class="nav-link" data-tab="health"><i class="bi bi-activity"></i> Theo dõi sức khỏe</a>
    <a href="#" class="nav-link" data-tab="alerts"><i class="bi bi-exclamation-triangle"></i> Cảnh báo</a>
    <a href="#" class="nav-link" data-tab="history"><i class="bi bi-clock-history"></i> Lịch sử đo</a>
    
    <div style="margin-top: auto; padding: 20px;">
        <button id="logoutBtn" class="btn btn-outline-light w-100"><i class="bi bi-box-arrow-right"></i> Đăng xuất</button>
    </div>
</div>

<div class="content">
    
    <!-- TAB: THÔNG TIN CÁ NHÂN -->
    <div id="tab-info" class="tab-content">
        <h3 class="mb-4 fw-bold text-dark">Hồ sơ bệnh nhân</h3>
        <div class="card">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6 border-end">
                        <h5 class="text-primary mb-4"><i class="bi bi-person-circle me-2"></i>Thông tin cơ bản</h5>
                        <div class="mb-3 row">
                            <label class="col-sm-4 col-form-label text-muted">Họ và tên</label>
                            <div class="col-sm-8 fw-bold fs-5 pt-1" id="full_name">...</div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-4 col-form-label text-muted">Ngày sinh</label>
                            <div class="col-sm-8 pt-1" id="date_of_birth">...</div>
                        </div>
                         <div class="mb-3 row">
                            <label class="col-sm-4 col-form-label text-muted">Số điện thoại</label>
                            <div class="col-sm-8 pt-1" id="phone_number">...</div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-4 col-form-label text-muted">Email</label>
                            <div class="col-sm-8 pt-1" id="email">...</div>
                        </div>
                    </div>
                    <div class="col-md-6 ps-md-5">
                        <h5 class="text-primary mb-4"><i class="bi bi-geo-alt-fill me-2"></i>Thông tin liên hệ</h5>
                        <div class="mb-3">
                            <label class="form-label text-muted">Địa chỉ</label>
                            <div class="fw-bold" id="address">...</div>
                        </div>
                        <hr>
                        <div class="mb-3">
                            <label class="form-label text-muted">Bác sĩ phụ trách</label>
                            <div class="fs-5 text-primary fw-bold" id="doctor_name">...</div>
                        </div>
                    </div>
                </div>
                <div class="text-end mt-4 pt-3 border-top">
                    <button id="change-pass-btn" class="btn btn-light me-2">Đổi mật khẩu</button>
                    <button id="update-info-btn" class="btn btn-primary">Cập nhật thông tin</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: THEO DÕI SỨC KHỎE (ĐÃ CHỈNH SỬA) -->
    <div id="tab-health" class="tab-content d-none">
        <h3 class="mb-4 fw-bold text-dark">Theo dõi sức khỏe</h3>
        
        <!-- Hàng 1: Trạng thái & Điều khiển thiết bị -->
        <div class="row g-4 mb-4">
            <!-- Cột Trái: Trạng thái AI -->
            <div class="col-md-6">
                <div class="card h-100 bg-white">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <i class="bi bi-cpu text-primary me-2"></i>Phân tích AI
                    </div>
                    <div class="card-body d-flex flex-column justify-content-center align-items-center text-center py-4">
                        <div class="mb-2 text-muted small">Trạng thái hiện tại</div>
                        <div id="health_status" class="fs-3 fw-bold status-unknown">Đang tải dữ liệu...</div>
                        <p class="text-muted mt-2 mb-0 fst-italic" style="font-size: 0.85rem;">
                            <i class="bi bi-info-circle me-1"></i>Hệ thống tự động phân tích nhịp tim và cử động để cảnh báo.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Cột Phải: Quản lý thiết bị -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-transparent border-0 pb-0 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-hdd-network text-success me-2"></i>Quản lý thiết bị</span>
                        <span class="badge bg-light text-dark border" id="device_serial">---</span>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center mb-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Trạng thái kết nối</small>
                                <span id="device_connection_status" class="fw-bold">...</span>
                            </div>
                            <div class="col-6 text-end">
                                <small class="text-muted d-block">Hoạt động</small>
                                <div id="measuring_status_text" class="fw-bold device-inactive">...</div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex">
                            <button id="btn-start-measure" class="btn btn-success flex-grow-1" disabled>
                                <i class="bi bi-play-fill me-1"></i>Bắt đầu đo
                            </button>
                            <button id="btn-stop-measure" class="btn btn-danger flex-grow-1" disabled>
                                <i class="bi bi-stop-fill me-1"></i>Dừng đo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hàng 2: Các chỉ số đo (6 ô) -->
        <div class="row g-3 mb-4">
            <div class="col-md-2 col-6">
                <div class="card h-100 text-center border-bottom border-3 border-danger">
                    <div class="card-body p-3">
                        <div class="stat-label">Nhịp tim (BPM)</div>
                        <div id="bpm_val" class="stat-value text-danger">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-6">
                <div class="card h-100 text-center border-bottom border-3 border-info">
                    <div class="card-body p-3">
                        <div class="stat-label">Cảm biến IR</div>
                        <div id="ir_val" class="stat-value text-info">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-4">
                <div class="card h-100 text-center">
                    <div class="card-body p-3">
                        <div class="stat-label">Gia tốc X</div>
                        <div id="accel_x_val" class="stat-value text-secondary">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-4">
                <div class="card h-100 text-center">
                    <div class="card-body p-3">
                        <div class="stat-label">Gia tốc Y</div>
                        <div id="accel_y_val" class="stat-value text-secondary">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-4">
                <div class="card h-100 text-center">
                    <div class="card-body p-3">
                        <div class="stat-label">Gia tốc Z</div>
                        <div id="accel_z_val" class="stat-value text-secondary">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-6">
                <div class="card h-100 text-center border-bottom border-3 border-primary">
                    <div class="card-body p-3">
                        <div class="stat-label">Tổng hợp lực</div>
                        <div id="a_total_val" class="stat-value text-primary">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hàng 3: Biểu đồ -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 text-secondary"><i class="bi bi-graph-up me-2"></i>Biểu đồ nhịp tim</h5>
            <select id="chart-range" class="form-select w-auto form-select-sm shadow-sm">
                <option value="day">Real-time (20 điểm gần nhất)</option>
                <option value="week">Trong tuần</option>
                <option value="month">Trong tháng</option>
            </select>
        </div>
        
        <div class="chart-container">
            <canvas id="bpmChart"></canvas>
        </div>
    </div>

    <!-- TAB: CẢNH BÁO -->
    <div id="tab-alerts" class="tab-content d-none">
        <h3 class="mb-4 fw-bold text-dark">Lịch sử cảnh báo</h3>
        <div class="card">
            <div class="card-body p-0">
                <div id="alerts-table" class="list-group list-group-flush">
                    <!-- Alerts sẽ được thêm vào đây -->
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: LỊCH SỬ -->
    <div id="tab-history" class="tab-content d-none">
        <h3 class="mb-4 fw-bold text-dark">Nhật ký dữ liệu</h3>
        <div class="card overflow-hidden">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>BPM</th>
                                <th>Lực tổng hợp</th>
                                <th>Đánh giá AI</th>
                                <th>Thời gian</th>
                                <th>Gia tốc (X, Y, Z)</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- Dữ liệu sẽ được thêm vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALS (Giữ nguyên) -->
<div class="modal fade" id="updateInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cập nhật thông tin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="updateInfoForm">
          <div class="mb-3"><label class="form-label">Họ và tên</label><input type="text" class="form-control" id="modalFullName"></div>
          <div class="mb-3"><label class="form-label">Số điện thoại</label><input type="text" class="form-control" id="modalPhone"></div>
          <div class="mb-3"><label class="form-label">Địa chỉ</label><input type="text" class="form-control" id="modalAddress"></div>
          <div class="mb-3"><label class="form-label">Ngày sinh</label><input type="date" class="form-control" id="modalDOB"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="saveInfoBtn">Lưu thay đổi</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Đổi mật khẩu</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <div id="changePassMsg" class="alert d-none"></div>
          <div class="mb-3"><label class="form-label">Mật khẩu cũ</label><input type="password" class="form-control" id="modalOldPass"></div>
          <div class="mb-3"><label class="form-label">Mật khẩu mới</label><input type="password" class="form-control" id="modalNewPass"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="saveNewPassBtn">Lưu thay đổi</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/js/patient.js"></script>

</body>
</html>