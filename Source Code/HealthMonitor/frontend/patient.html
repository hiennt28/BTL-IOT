<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Bệnh nhân</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {font-family: Arial, sans-serif;}
.sidebar {width: 200px; position: fixed; top:0; left:0; height:100%; background:#343a40; padding-top:20px;}
.sidebar .nav-link {color:#fff; display:block; padding:10px;}
.sidebar .nav-link.active {background:#495057;}
.content {margin-left:210px; padding:20px;}
.card {margin-bottom:15px;}
.tab-content {margin-top:15px;}

.user-profile {
  text-align: center;
  padding: 15px;
  border-bottom: 1px solid #495057;
  margin-bottom: 10px;
}
.user-profile h5 {
  color: #fff;
  font-weight: bold;
  font-size: 1.1rem;
  margin-bottom: 3px;
}
.user-profile p {
  color: #adb5bd;
  font-size: 0.9rem;
  margin-bottom: 0;
  text-transform: capitalize;
}

/* === CẬP NHẬT MỚI: CSS cho trạng thái === */
.status-normal { color: #198754; } /* Green */
.status-light { color: #0dcaf0; } /* Cyan */
.status-medium { color: #fd7e14; } /* Orange */
.status-strong { color: #dc3545; } /* Red */
.status-warning { color: #dc3545; font-weight: bold; } /* Red Bold */
.status-unknown { color: #6c757d; } /* Gray */
/* === KẾT THÚC CẬP NHẬT === */

</style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="user-profile">
        <h5 id="userProfileName">Đang tải...</h5>
        <p id="userProfileRole">Bệnh nhân</p>
    </div>

    <a href="#" class="nav-link active" data-tab="info">Thông tin cá nhân</a>
    <a href="#" class="nav-link" data-tab="health">Theo dõi sức khỏe</a>
    <a href="#" class="nav-link" data-tab="alerts">Cảnh báo</a>
    <a href="#" class="nav-link" data-tab="history">Lịch sử</a>
    <hr>
    <button id="logoutBtn" class="btn btn-danger w-100">Đăng xuất</button>
</div>

<div class="content">
    <!-- Thông tin cá nhân -->
    <div id="tab-info" class="tab-content">
        <h3>Thông tin cá nhân</h3>
        <div class="card">
            <div class="card-body">
                <p><strong>Họ và tên:</strong> <span id="full_name"></span></p>
                <p><strong>Email:</strong> <span id="email"></span></p>
                <p><strong>Số điện thoại:</strong> <span id="phone_number"></span></p>
                <p><strong>Địa chỉ:</strong> <span id="address"></span></p>
                <p><strong>Ngày sinh:</strong> <span id="date_of_birth"></span></p>
                <hr>
                <p><strong>Bác sĩ phụ trách:</strong> <span id="doctor_name" class="text-primary fw-bold"></span></p>
                
                <!-- === CẬP NHẬT MỚI: Hiển thị trạng thái AI === -->
                <p class="fs-5"><strong>Trạng thái sức khỏe (AI):</strong> 
                   <span id="health_status" class="fw-bold status-unknown">Đang tải...</span>
                </p>
                <!-- === KẾT THÚC CẬP NHẬT === -->
                
                <button id="update-info-btn" class="btn btn-primary mt-2">Cập nhật thông tin</button>
                <button id="change-pass-btn" class="btn btn-warning mt-2">Đổi mật khẩu</button>
            </div>
        </div>
    </div>

    <!-- Theo dõi sức khỏe -->
    <div id="tab-health" class="tab-content d-none">
        <h3>Dữ liệu sức khỏe</h3>
        <div class="row">
            <div class="col-md-2"><div class="card"><div class="card-body">BPM: <span id="bpm_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">IR: <span id="ir_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">Accel X: <span id="accel_x_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">Accel Y: <span id="accel_y_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">Accel Z: <span id="accel_z_val">0</span></div></div></div>
            <div class="col-md-2"><div class="card"><div class="card-body">A total: <span id="a_total_val">0</span></div></div></div>
        </div>
        <hr>
        <label>Chọn khoảng thời gian:</label>
        <select id="chart-range" class="form-select w-25 mb-3">
            <option value="day">Ngày</option>
            <option value="week">Tuần</option>
            <option value="month">Tháng</option>
        </select>
        
        <div class="chart-container" style="position: relative; height:250px; width:100%">
            <canvas id="bpmChart"></canvas>
        </div>
    </div>

    <!-- Cảnh báo -->
    <div id="tab-alerts" class="tab-content d-none">
        <h3>Cảnh báo</h3>
        <div id="alerts-table" class="list-group"></div>
    </div>

    <!-- Lịch sử -->
    <div id="tab-history" class="tab-content d-none">
        <h3>Lịch sử đo sức khỏe</h3>
        <table class="table table-bordered table-striped">
            <thead>
                <!-- === CẬP NHẬT MỚI: Thêm cột Trạng thái (AI) === -->
                <tr><th>BPM</th><th>A total</th><th>Trạng thái (AI)</th><th>Thời gian</th><th>Accel X</th><th>Accel Y</th><th>Accel Z</th></tr>
            </thead>
            <tbody id="history-table-body"></tbody>
        </table>
    </div>
</div>

<!-- Modal cập nhật thông tin cá nhân -->
<div class="modal fade" id="updateInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cập nhật thông tin cá nhân</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateInfoForm">
          <div class="mb-3">
            <label for="modalFullName" class="form-label">Họ và tên</label>
            <input type="text" class="form-control" id="modalFullName" required>
          </div>
          <div class="mb-3">
            <label for="modalPhone" class="form-label">Số điện thoại</label>
            <input type="text" class="form-control" id="modalPhone">
          </div>
          <div class="mb-3">
            <label for="modalAddress" class="form-label">Địa chỉ</label>
            <input type="text" class="form-control" id="modalAddress">
          </div>
          <div class="mb-3">
            <label for="modalDOB" class="form-label">Ngày sinh</label>
            <input type="date" class="form-control" id="modalDOB">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="saveInfoBtn">Lưu</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Đổi mật khẩu -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Đổi mật khẩu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <div id="changePassMsg" class="alert d-none" role="alert"></div>
          <div class="mb-3">
            <label for="modalOldPass" class="form-label">Mật khẩu cũ</label>
            <input type="password" class="form-control" id="modalOldPass" required>
          </div>
          <div class="mb-3">
            <label for="modalNewPass" class="form-label">Mật khẩu mới</label>
            <input type="password" class="form-control" id="modalNewPass" required>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" id="saveNewPassBtn">Lưu</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// === Hàm định dạng ngày (không đổi) ===
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
    } catch (e) {
        return dateString;
    }
}
function formatDateForInput(dateString) {
    if (!dateString) return '';
     try {
        const date = new Date(dateString);
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${year}-${month}-${day}`;
     } catch (e) {
        return '';
     }
}
// === KẾT THÚC HÀM ĐỊNH DẠNG ===

// === CẬP NHẬT MỚI: Hàm lấy class CSS cho trạng thái ===
function getStatusClass(status) {
    if (!status) return 'status-unknown';
    status = status.toLowerCase();
    if (status.includes('cảnh báo') || status.includes('nguy hiểm') || status.includes('bất thường')) {
        return 'status-warning';
    }
    if (status.includes('hoạt động mạnh') || status.includes('cực độ')) {
        return 'status-strong';
    }
    if (status.includes('hoạt động trung bình')) {
        return 'status-medium';
    }
    if (status.includes('hoạt động nhẹ')) {
        return 'status-light';
    }
    if (status.includes('bình thường')) {
        return 'status-normal';
    }
    return 'status-unknown'; // Mặc định
}
// === KẾT THÚC HÀM CSS ===


document.addEventListener("DOMContentLoaded", async () => {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role !== 'patient') { window.location.href="/login.html"; return; }
    
    const patientId = user.patient_id;
    
    document.getElementById("userProfileName").innerText = user.full_name;
    document.getElementById("userProfileRole").innerText = user.role;

    let updateInfoModal = new bootstrap.Modal(document.getElementById('updateInfoModal'));
    let changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
    let currentPatientData = {};

    // Sidebar tab switching
    document.querySelectorAll("#sidebar .nav-link").forEach(link => {
        link.addEventListener("click", e => {
            e.preventDefault();
            document.querySelectorAll("#sidebar .nav-link").forEach(l=>l.classList.remove("active"));
            link.classList.add("active");
            document.querySelectorAll(".tab-content").forEach(t=>t.classList.add("d-none"));
            document.getElementById("tab-" + link.dataset.tab).classList.remove("d-none");
            
            // === CẬP NHẬT MỚI: Tải lại lịch sử khi nhấn tab ===
            if (link.dataset.tab === 'history') {
                loadHistory();
            }
        });
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", ()=> {
        localStorage.removeItem("user");
        window.location.href="/login.html";
    });

    // Load thông tin cá nhân
    async function loadPatientInfo() {
        try {
            const res = await fetch(`/api/patients/${patientId}`);
            if(!res.ok) throw new Error("Không tìm thấy bệnh nhân!");
            const data = await res.json();
            
            currentPatientData = data; 

            document.getElementById("full_name").innerText = data.full_name;
            document.getElementById("email").innerText = data.email; 
            document.getElementById("phone_number").innerText = data.phone_number || '';
            document.getElementById("address").innerText = data.address || '';
            document.getElementById("date_of_birth").innerText = formatDate(data.date_of_birth) || '';
            document.getElementById("doctor_name").innerText = data.doctor_name || 'Chưa được gán';

            // === CẬP NHẬT MỚI: Hiển thị trạng thái AI ===
            const statusSpan = document.getElementById("health_status");
            const statusText = data.current_health_status || 'Chưa cập nhật';
            statusSpan.innerText = statusText;
            // Cập nhật class CSS
            statusSpan.className = "fw-bold " + getStatusClass(statusText);
            // === KẾT THÚC CẬP NHẬT ===

        } catch(err) { console.error("Lỗi khi lấy dữ liệu bệnh nhân!", err); }
    }
    
    // Tải thông tin lần đầu
    await loadPatientInfo();
    
    // === CẬP NHẬT MỚI: Tải lại thông tin cá nhân (để lấy trạng thái) mỗi 5s ===
    setInterval(loadPatientInfo, 5000);


    // Modal cập nhật thông tin (không đổi)
    document.getElementById("update-info-btn").addEventListener("click", ()=> {
        document.getElementById("modalFullName").value = currentPatientData.full_name || '';
        document.getElementById("modalPhone").value = currentPatientData.phone_number || '';
        document.getElementById("modalAddress").value = currentPatientData.address || '';
        document.getElementById("modalDOB").value = formatDateForInput(currentPatientData.date_of_birth) || '';
        updateInfoModal.show();
    });

    // Lưu thông tin (không đổi)
    document.getElementById("saveInfoBtn").addEventListener("click", async ()=> {
        const body = {
            full_name: document.getElementById("modalFullName").value,
            phone_number: document.getElementById("modalPhone").value,
            address: document.getElementById("modalAddress").value,
            date_of_birth: document.getElementById("modalDOB").value
        };
        try {
            const res = await fetch(`/api/patients/update/${patientId}`, {
                method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
            });
            if(!res.ok) throw new Error("Cập nhật thất bại!");
            await loadPatientInfo();
            updateInfoModal.hide();
        } catch(err) { alert(err.message); }
    });
    
    // Đổi mật khẩu (không đổi)
    document.getElementById("change-pass-btn").addEventListener("click", () => {
        document.getElementById("modalOldPass").value = "";
        document.getElementById("modalNewPass").value = "";
        document.getElementById("changePassMsg").classList.add('d-none');
        changePasswordModal.show();
    });
    document.getElementById("saveNewPassBtn").addEventListener("click", async () => {
        const old_password = document.getElementById("modalOldPass").value;
        const new_password = document.getElementById("modalNewPass").value;
        const msgEl = document.getElementById("changePassMsg");
        try {
            const res = await fetch(`/api/auth/change-password`, {
                method:"POST", headers:{"Content-Type":"application/json"},
                body: JSON.stringify({ email: user.email, role: user.role, old_password, new_password })
            });
            const data = await res.json();
            if (data.success) {
                msgEl.textContent = data.message;
                msgEl.className = 'alert alert-success';
                setTimeout(() => changePasswordModal.hide(), 1500);
            } else {
                msgEl.textContent = data.message;
                msgEl.className = 'alert alert-danger';
            }
        } catch(err) {
            msgEl.textContent = "Lỗi máy chủ!";
            msgEl.className = 'alert alert-danger';
        }
    });


    // Load dữ liệu realtime health (không đổi)
    async function loadLatestHealth(){
        try {
            const res = await fetch(`/api/health/latest/${patientId}`);
            if(!res.ok) return;
            const data = await res.json();
            document.getElementById("bpm_val").innerText = data.bpm || 'N/A';
            document.getElementById("ir_val").innerText = data.ir_value || 'N/A';
            document.getElementById("accel_x_val").innerText = data.accel_x || 'N/A';
            document.getElementById("accel_y_val").innerText = data.accel_y || 'N/A';
            document.getElementById("accel_z_val").innerText = data.accel_z || 'N/A';
            document.getElementById("a_total_val").innerText = data.a_total || 'N/A';
        } catch(err) { console.error(err); }
    }
    loadLatestHealth(); setInterval(loadLatestHealth, 5000);

    // Load chart (không đổi)
    let bpmChart;
    async function loadChart(range="day"){
        try {
            const res = await fetch(`/api/health/history/${patientId}?range=${range}`);
            if(!res.ok) return;
            const data = await res.json();
            const ctx = document.getElementById("bpmChart").getContext("2d");
            const labels = data.map(d=>new Date(d.timestamp).toLocaleString());
            const bpmValues = data.map(d=>d.bpm);
            if(bpmChart) bpmChart.destroy();
            bpmChart = new Chart(ctx,{
                type:"line",
                data:{labels,datasets:[{label:"BPM",data:bpmValues,borderColor:"red",fill:false}]},
                options:{responsive:true,maintainAspectRatio:false}
            });
        } catch(err){ console.error(err); }
    }
    loadChart("day");
    document.getElementById("chart-range").addEventListener("change", e=> loadChart(e.target.value));

    // Load alerts (không đổi)
    async function loadAlerts(){
        try {
            const res = await fetch(`/api/alerts/${patientId}`);
            if(!res.ok) return;
            const data = await res.json();
            const container = document.getElementById("alerts-table");
            container.innerHTML = "";
            if (data.length === 0) {
                container.innerHTML = "<p>Không có cảnh báo nào.</p>";
                return;
            }
            data.forEach(a=>{
                const div = document.createElement("div");
                let statusClass = 'list-group-item-secondary';
                if (a.status === 'new') statusClass = 'list-group-item-danger';
                if (a.status === 'viewed') statusClass = 'list-group-item-warning';
                
                div.className = "list-group-item " + statusClass;
                div.innerHTML = `
                    <strong>${a.alert_type} (Trạng thái: ${a.status})</strong>
                    <p>${a.message}</p>
                    <small class="text-muted">${new Date(a.timestamp).toLocaleString()}</small>
                `;
                container.appendChild(div);
            });
        } catch(err){ console.error(err); }
    }
    loadAlerts();

    // Load history
    async function loadHistory(){
        try {
            const res = await fetch(`/api/health/history/${patientId}?range=month`); // Lấy 1 tháng gần nhất
            if(!res.ok) return;
            const data = await res.json();
            const tbody = document.getElementById("history-table-body");
            tbody.innerHTML = "";
            
            // === CẬP NHẬT MỚI: Hiển thị 50 bản ghi và thêm cột AI ===
            data.reverse().slice(0, 50).forEach(d=>{
                const tr = document.createElement("tr");
                const statusText = d.predicted_status || 'N/A';
                const statusClass = getStatusClass(statusText);
                
                tr.innerHTML = `
                    <td>${d.bpm || ''}</td>
                    <td>${d.a_total ? d.a_total.toFixed(2) : ''}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${new Date(d.timestamp).toLocaleString()}</td>
                    <td>${d.accel_x || ''}</td>
                    <td>${d.accel_y || ''}</td>
                    <td>${d.accel_z || ''}</td>`;
                tbody.appendChild(tr);
            });
            // === KẾT THÚC CẬP NHẬT ===
            
        } catch(err){ console.error(err); }
    }
    
    // Tải lịch sử cho tab đầu tiên (nếu là history)
    if(document.querySelector("#sidebar .nav-link.active").dataset.tab === 'history'){
        loadHistory();
    }
});
</script>

</body>
</html>